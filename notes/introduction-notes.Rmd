---
title: "intro-to-r"
author: "Alex Hollingsworth, Grant McDermott, and Kelli Marquardt"
date: "7/7/2021"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction 

This is an R-Markdown document. It's a combination of text that is formatted using markdown syntax, R code, and results from running R code. 

- If you are curious about markdown formatting, you can check out this handy guide. https://www.markdownguide.org/basic-syntax/
- To learn more about R-Markdown, this "cheat-sheet" https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf, is a good starting place. 

Basically all of the syntax like italics, headings, bold, citations is added using plain text and is "knit" into a formatted output. It's a bit like Latex in this regard. A nice feature of R-markdown is that you can output in a few different formats: html, pdf, rich text. You can also use a companion `.css` file that contains information on custom formatting preferences, which is especially helpful for html output.

This document is about as vanilla as it gets. 

## Simple example 

### Load packages into memory 

In R, you load packages into your memory. The package must be installed already. Think of it like an application on your phone. Here we are going to load the `ggplot2` package, which is an excellent graphics package. `gg` here stands for "grammar of graphics". This is a part of the `tidyverse` you may have heard of. 

I will also load the `dplyr` package (also a part of the `tidyverse`) so we can write some cleaner code using "pipes" (the `%>%` syntax). 

```{r load-packages}
library(ggplot2)
library(dplyr)
```

Now that this is loaded into memory, we can begin to use it. Much like stata's auto dataset, many packages have pre-installed datasets that are useful for tutorials and debugging. 

We can look at the first five observations using the `head` command

### View data

```{r head-of-data} 
head(diamonds)
```

We can get a list of column names fairly easily too

```{r list-of-column-names}
names(diamonds)
```

Let's compute the average price by color 

```{r mean-price-by-color}
diamonds %>% group_by(color) %>% summarise(mean(price)) 
```

Here the pipe command `%>%` will take the output from the command on the left and "pipe" it as input to the command on the right. So above we 

1. take the dataset called diamonds 
1. send it as input to the command `group_by`, which groups by the unique values in the column `color`
1. We then send this grouped data to the `summarize` command, which calculates the mean price in each group. 

Two things to note. First off, you can just move onto a new line without an error. This is neat because it allows us to write cleaner code and you don't need a delimiter or the `///` you may be used to from stata. So we can rewrite the above like this. 

```{r mean-price-by-color-cleaner}
diamonds %>% 
    group_by(color) %>% 
    summarize(mean(price)) 
```

Second, in more recent versions of R (4.1 and above), you don't need to have `dpylr` installed to pipe. You can do the same thing using `|>`. 

```{r mean-price-by-color-new-pipe}
diamonds |>
    group_by(color) |>
    summarize(mean(price)) 
```

Note: In this example, `%>%` and `|>` are interchangeable, but the two are not interchangeable in all settings. See https://www.r-bloggers.com/2021/05/the-new-r-pipe/ for more details. 

### Simple scatter plot

Here we will use the `ggplot` function. You can learn more about any R function by typing in `?` before the function name (e.g., `?ggplot`).

- On the first line, we call the function, then clarify  the dataset we wish to use (referable to by its name, `diamonds`), the y-variable (`price`), and the x-variable (`carat`). 
- On the second line, we clarify that we want the geometry to be points

```{r}
ggplot(data = diamonds, aes(y = price, x = carat)) +
    geom_point() 
```

Think changing graphic features in ggplot as adding layers. You can do this by repeating all of the same code. Or by saving the above as an object then adding to that object.

For example let's add a third line where use a default theme called classic that I like. 

```{r}
ggplot(data = diamonds, aes(y = price, x = carat)) +
    geom_point() +
    theme_classic()
```

We can obtain the same result, by saving the above as an object and adding to it. 

```{r}
base_plot <- ggplot(data = diamonds, aes(y = price, x = carat)) +
    geom_point()
```

The `<-` arrow assigns the code after it to the name `base_plot` 

```{r}
base_plot +
    theme_classic()
```

All we need to do is add this theme line to the above. 

### Deviations from simple scatter plot

It's very simple to make complex plots in R. 

We can add some transparency 
```{r}
ggplot(data = diamonds, aes(y = price, x = carat)) +
    geom_point(alpha = .33) +
    theme_classic()
```

Customized labels and increased size of text
```{r}
ggplot(data = diamonds, aes(y = price, x = carat)) +
    geom_point(alpha = .1) +
    theme_classic() + 
    theme(text = element_text(size = 18)) +
    labs(title = "Larger diamonds cost more", 
          subtitle = "Price, $",
          y = "", 
          x = "Carat")
```

Recall that the data contain information on color. We can easily create small multiples of the same graph. 

```{r}
ggplot(data = diamonds, aes(y = price, x = carat)) +
    geom_point(alpha = .1) +
    facet_wrap(~color) +
    theme_classic() + 
    theme(text = element_text(size = 14)) +
    labs(title = "Larger diamonds cost more by diamond color", 
          subtitle = "Price, $",
          y = "", 
          x = "Carat")
```
Similarly, we can add color based on clarity 
```{r}
ggplot(data = diamonds, aes(y = price, x = carat, color = clarity)) +
    geom_point(alpha = .33) +
    facet_wrap(~color) +
    theme_classic() + 
    theme(text = element_text(size = 14)) +
    labs(title = "Larger diamonds cost more by diamond color", 
          subtitle = "Price, $",
          y = "", 
          x = "Carat")
```

It's also trivial to add a regression line to each. We will pick method `lm`, which is a simple linear regression.

```{r}
ggplot(data = diamonds, aes(y = price, x = carat, color = clarity)) +
    geom_point(alpha = .33) +
    facet_wrap(~color) + 
    geom_smooth(method = "lm") +
    theme_classic() + 
    theme(text = element_text(size = 14)) +
    labs(title = "Larger diamonds cost more by diamond color", 
          subtitle = "Price, $",
          y = "", 
          x = "Carat")
```

We can even remove the points below by simply removing the second line

```{r}
ggplot(data = diamonds, aes(y = price, x = carat, color = clarity)) +
    facet_wrap(~color) + 
    geom_smooth(method = "lm") +
    theme_classic() + 
    theme(text = element_text(size = 14)) +
    labs(title = "Larger diamonds cost more by diamond color", 
          subtitle = "Price, $",
          y = "", 
          x = "Carat")
```

Viewing the data this way, adds nuance to the earlier tabulation stats. D color diamonds are cheaper on average perhaps because they are smaller. Let's check on price by color, conditional on size. 

### Run a regression

To do this we can use a few different methods. We will use `modelsummary` and `etable` (from fixest) to dispay the results

####  Base R
The `lm` function

```{r}
base_model <- lm(price ~ carat, data = diamonds)
```

Load model summary into memory 

```{r}
library(modelsummary)
```

Display the base_model using model summary 

```{r}
modelsummary(base_model) 
```

We can tweak this output to look a bit better. We will use the nice `kableExtra` package to help. 
```{r}
library(kableExtra)
```

```{r}
modelsummary(base_model,  
  title = "Fantastic regression table", 
  stars = TRUE,
  gof_omit = "Adj|Pseudo|Log|AIC|BIC|F|R2", 
  coef_omit = c("(Intercept)"), 
  coef_rename = c("carat" = "Carat", 
                  "Num.Obs." = "N")) %>%
  add_footnote("An important note.",
  threeparttable = TRUE)
```

Now we can run all sorts of other models and display them side-by-side. Let's add some controls 

```{r}
model_add_controls <- lm(price ~ carat + depth + table , data = diamonds)
```

We can add this model to a list with the base model. We name each item here.
```{r}
models <- list(
    "Base"  = base_model, 
    "Add Controls"  = model_add_controls
    )
```

We can use the same format as earlier. 
```{r}
modelsummary(models,  
  title = "Fantastic regression table", 
  stars = TRUE,
  gof_omit = "Adj|Pseudo|Log|AIC|BIC|F|R2", 
  coef_omit = c("(Intercept)"), 
  coef_rename = c("carat" = "Carat", 
                  "Num.Obs." = "N")) %>%
  add_footnote("An important note.",
  threeparttable = TRUE)
```

Next, we will use `fixest` to run a regression with fixed effects. 

```{r}
library(fixest)
```

The fixed effects are those after the `|` indicator. 

```{r}
fe_model <- feols(price ~ carat + depth + table | color + cut + clarity, data = diamonds)
```

We can create a similar list as earlier. 

```{r}
models <- list(
    "Base"  = base_model, 
    "Add Controls"  = model_add_controls,
    "Fixed-Effects" = fe_model
)
```

```{r}
modelsummary(models,  
  title = "Fantastic regression table", 
  stars = TRUE,
  gof_omit = "Adj|Pseudo|Log|AIC|BIC|F|R2", 
  coef_omit = c("(Intercept)"), 
  coef_rename = c("carat" = "Carat", 
                  "Num.Obs." = "N")) %>%
  add_footnote("An important note.",
  threeparttable = TRUE)
```
See more html display options here, https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html


Now we can export this to latex

```{r}
modelsummary(models,  
  title = "Fantastic regression table", 
  stars = TRUE,
  gof_omit = "Adj|Pseudo|Log|AIC|BIC|F|R2", 
  coef_omit = c("(Intercept)"), 
  coef_rename = c("carat" = "Carat", 
                  "Num.Obs." = "N"), 
  output = 'output/table.tex')
```

#### Table using `etable`

We can also use the `etable` function that is a part of `fixest` package. 

```{r}
models_for_etable <- list(
    "Fixed-Effects" = fe_model
)
```

```{r}
etable(models_for_etable) %>%
    kbl(caption = "Fantastic regression table") %>%
    kable_styling(full_width = F)
```

### Make a summary statistics table

Part of the reason `modelsummary` is so good is that we can create summary statistics tables quite esaily with it. The `datasummary_skim` is quite nice
```{r}
datasummary_skim(diamonds)
```

But not every variable is numeric. `datasummary` has this covered. 

```{r}
datasummary_skim(diamonds, type="categorical")
```

Learn more about `datasummary` here: https://vincentarelbundock.github.io/modelsummary/articles/datasummary.html 